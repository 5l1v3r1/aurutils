#!/bin/bash
# aur-srcver - update and print package revisions
readonly argv0=srcver
readonly PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
readonly startdir=$PWD

srcver_pkgbuild_info() {
    env -i bash -c '
        PATH= source PKGBUILD

        if [[ -v epoch ]]; then
            fullver=$epoch:$pkgver-$pkgrel
        else
            fullver=$pkgver-$pkgrel
        fi

        printf %s\\t%s\\n "${pkgbase:-$pkgname}" "$fullver"
    '
}
export -f srcver_pkgbuild_info

srcver_pkgbuild_path() {
    if cd -- "$1" && makepkg --skipinteg --noprepare -od; then
        srcver_pkgbuild_info | tee -a -- "$OLDPWD"/processed
    else
        return
    fi
}
export -f srcver_pkgbuild_path

trap_exit() {
    if ! [[ -o xtrace ]]; then
        rm -rf "$tmp"
    fi
}

if ! (($#)); then
    printf >&2 'usage: %s path...\n' "$argv0"
    exit 1
fi

tmp=$(mktemp -dt "$argv0".XXXXXXXX) || exit
trap 'trap_exit' EXIT

if cd "$tmp"; then
    aur jobs --nice 10 -j +2 --joblog makepkg_log --results '{#}_makepkg' \
        'srcver_pkgbuild_path' >/dev/null 2>&1 ::: "$@"
    jobs_exit=$?
else
    exit 1
fi

if ((jobs_exit > 101)); then
    printf >&2 '%s: error running "parallel", exit code %d\n' "$argv0" "$jobs_exit"
    exit "$jobs_exit"
fi

if ((jobs_exit > 0)); then
    printf >&2 '%s: failed to update %s packages\n' "$argv0" "$jobs_exit"

    while IFS=$'\t' read -r seq _ _ _ _ _ makepkg_exit _ command; do
        if ((makepkg_exit)); then
            printf >&2 '8<----\n'
            printf >&2 '%s\n' "$command"

            cat "${seq}_makepkg" >&2
            cat "${seq}_makepkg.err" >&2
        else
            continue
        fi
    done < makepkg_log

    exit "$jobs_exit"
else
    cat "$tmp"/processed
fi

# vim: set et sw=4 sts=4 ft=sh:
