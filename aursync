#!/bin/bash
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -e -o pipefail

argv0=aursync
aurweb=https://aur.archlinux.org
tarpath=$aurweb/cgit/aur.git/snapshot
tmp=$(mktemp -d)

XDG_CACHE_HOME=${XDG_CACHE_HOME:-$HOME/.cache}
AURDEST=${AURDEST:-$XDG_CACHE_HOME/$argv0}

readonly argv0 aurweb rpc tarpath tmp XDG_CACHE_HOME AURDEST

viewer() {
    if hash 2>/dev/null vifm; then
	vifm - '+view!'
    else
	command -- "${PAGER:-less}"
    fi
}

inspect() {
    xargs -i find {} -maxdepth 1 | viewer
}

findsrc() {
    xargs -i find {} -maxdepth 1 -type f -name .SRCINFO -print0
}

genver() {
    xargs -0i awk -F'[= ]' '
        /^\tpkgver/ {ver = $4;}
        /^\tpkgrel/ {rel = $4;}
        /^pkgname/  {printf "%s=%s-%s\n", $4, ver, rel;}
    ' {}
}

clone() {
    while read -r base; do
        ( if cd "$base" 2>/dev/null; then
              git pull -v
          else
              git clone "$aurweb/$base".git -v 
          fi
	)
    done
}

snapshot() {
    awk -v uri=$tarpath '{
        gsub("+","%2b")
        gsub("@","%40")
        printf "%s/%s.tar.gz\n", uri, $1
    }' | aria2c -d "$tmp" -i -

    mkdir -p snapshot

    for ar in "$tmp"/*.tar.gz; do
        tar xvf "$ar" -C snapshot
    done
}

# Take package names from stdin, build arguments after "pkgname=pkgver-pkgrel",
# relay them to pacsift, then filter for pkgbase (or pkgname, if unavailable).
prepare() {
    while read -r pkg; do
        siftargs+=(--satisfies "$pkg")
    done

    pacsift --sync --exact "${siftargs[@]}" <&- | pacinfo | awk '
       /^Name:/ {n = $2}
       /^Base:/ {if($2 == "(null)") print n; else print $2 | "sort -u";}
    '
}

notify() {
    while read -r line; do
	msg2 "$line is up-to-date"
    done
}

trap 'rm -rf "$tmp"' EXIT

source /usr/share/makepkg/util.sh

[[ -t 2 ]] && colorize

while getopts :cfnt OPT; do
    case $OPT in
        c|+c) aurbuild_args+=(-c) ;;
	f|+f) aurbuild_args+=(-f) ;;
	k|+k) insecure=1          ;;
	n|+n) noprepare=1         ;;
        t|+t) download=snapshot   ;;
        *)    plain "usage: $argv0 [+-cfnt} [--] ARGS..."
              exit 1 ;;
    esac
done
shift $((OPTIND - 1))
OPTIND=1

# Operations are done in the cache directory, unless said otherwise.
mkdir -p "$AURDEST" -m 700
cd "$AURDEST"

# The queue is saved to a temporary copy for later processing.
aurchain "$@" | tee "$tmp"/queue | "${download:-clone}"

if ! ((insecure)); then
    inspect < "$tmp"/queue
fi

if ! ((noprepare)); then
    findsrc < "$tmp"/queue | genver | prepare | tee "$tmp"/up | notify
    
    grep -Fvxf "$tmp"/up "$tmp"/queue > "$tmp"/queue.new
else
    cp "$tmp"/queue "$tmp"/queue.new
fi

read -r repo pool < <(repofind -s)

aurbuild_args+=(-d "$repo".db -r "$pool" -p "$pool")
aurbuild "${aurbuild_args[@]}" "$tmp"/queue.new
