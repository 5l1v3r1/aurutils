#!/bin/bash
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o pipefail

readonly XDG_CACHE_HOME=${XDG_CACHE_HOME:-$HOME/.cache}
readonly AURDEST=${AURDEST:-$XDG_CACHE_HOME/aursync}

confirm() {
    local -l reply
    local message=$*

    read -rp "$message [Y/n] " reply
    [[ ! $reply || $reply = y?(es) ]]
}

clone() {
    while read -r src; do
	if cd "$AURDEST/$src" 2>/dev/null; then
            if ! git pull -v; then
		return
            fi
	else
            if ! git clone -v https://aur.archlinux.org/"$src".git; then
		return
            fi
	fi
    done
}

snapshot() {
    if tmp=$(mktemp -d) && cd "$tmp"; then
	awk -v rpc=$rpc '{
	    gsub("+","%2b"); gsub("@","%40");
	    printf "https://aur.archlinux.org/cgit/aur.git/snapshot/%s.tar.gz\n", $1
	}' | aria2c -s 16 -x 16 -j 32 -i -

	for ar in ./*.tar.gz; do
	    tar xvf "$ar" -C "$AURDEST"/ || return
	done

	rm -rf "$tmp"
    fi
}

cd "$AURDEST" || exit 1

if aurchain "$@" | tee queue | snapshot; then
    if confirm 'Inspect build files?'; then
        xargs -a queue -i find {} -maxdepth 1 | vifm - -c '+vie'
    fi
    aurbuild queue
fi
