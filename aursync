#!/bin/bash
export PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'

readonly argv0=aursync
readonly tmp=$(mktemp) || exit 1

trap 'rm "$tmp"' EXIT

while read -r target; do
   ( if cd "$target" && [[ -d .git ]]; then
        if ! git pull -v; then
            printf '%s\n' "$target 1" >> "$tmp"
        fi
    else
        if ! git clone -v https://aur.archlinux.org/"$target".git; then
            printf '%s\n' "$target 1" >> "$tmp"
        fi
    fi
    ) &
done

wait

awk '{if($2 != 0) printf "Failed to sync: %s\n", $1}' < "$tmp" 2>/dev/null
