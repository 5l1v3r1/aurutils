#!/bin/bash
readonly argv0=aurbuild
readonly pwd=$PWD
readonly repo=${repo:-custom}

trap 'exit' INT

source /usr/share/makepkg/util.sh || exit 1
source /etc/makepkg.conf || exit 1

[[ -t 2 ]] && colorize

if [[ ! -d $PKGDEST ]]; then
    error "$PKGDEST: not a directory (PKGDEST)"
    exit 1
fi

hash powerpill 2>/dev/null && cmd=powerpill

while read -r pkg; do
    if cd "$pwd/$pkg"; then
        if PACMAN="${cmd:-pacman}" LC_MESSAGES=C makepkg -Lsc --noconfirm; then
            repose -vf "$repo".db -r "$PKGDEST" -p "$PKGDEST"
            sudo pacsync "$repo"
        else
            error "$pkg: build failure"
            exit 1
        fi
    fi
done

# vim: set sw=4 sts=4:
