#!/bin/bash -e
# WARNING! ALL VOIDED WARRANTY IS VOIDED-ER IF YOU USE THIS SCRIPT! 

readonly cache="${XDG_CACHE_HOME:-$HOME/.cache}/aursearch"
readonly remote="https://aur.archlinux.org"
readonly rpc="$remote/rpc/?v=5&type=info"

filter() {
    tee # TBD
}

source /usr/share/makepkg/util.sh || exit 1

if ((!$#)); then
    error "aursearch: pattern"
    exit 1
fi

[[ -t 2 ]] && colorize

msg "Retrieving package list"
curl -sS "$remote"/packages.gz -o "$cache"/packages.gz -z "$cache"/packages.gz -                                                                                                                                                                                               -create-dirs

msg "Collecting data"
while read -r p; do
    args+=("arg[]=$p")
    ((++a)); if ((a == 150)); then
    printf '%s\n' "${args[*]}" > tmp_"$((++i))"
        unset a args
    fi
done < <(zgrep -P -- "$1" "$cache"/packages.gz)
printf '%s\n' "${args[*]}" > tmp_"$((++i))"

msg "Sending request"
LC_COLLATE=C
while read -r -a tmp; do
    ((++r)); unset enc
    for t in "${tmp[@]}"; do
        enc+=(--data-urlencode "$t")
    done
    curl -sSgG --compressed "$rpc" "${enc[@]}" -o raw_"$r" &
done < <(cat ./tmp_*)
wait
#!/bin/bash -e

readonly cache="${XDG_CACHE_HOME:-$HOME/.cache}/aursearch"
readonly remote="https://aur.archlinux.org"
readonly rpc="$remote/rpc/?v=5&type=info"

filter() {
    tee # TBD
}

source /usr/share/makepkg/util.sh || exit 1

if ((!$#)); then
    error "aursearch: pattern"
    exit 1
fi

[[ -t 2 ]] && colorize

msg "Retrieving package list"
curl -sS "$remote"/packages.gz -o "$cache"/packages.gz -z "$cache"/packages.gz --create-dirs

msg "Sending request"
while read -r p; do
    args+=("arg[]=$p")
    ((++a)); if ((a == 150)); then
	printf '%s\n' "${args[*]}" > tmp_"$((++i))"
	unset a args
    fi
done < <(zgrep -P -- "$1" "$cache"/packages.gz)
printf '%s\n' "${args[*]}" > tmp_"$((++i))"

LC_COLLATE=C
while read -r -a tmp; do
    unset enc
    for t in "${tmp[@]}"; do
	enc+=(--data-urlencode "$t")
    done
    curl -sSgG "$rpc" "${enc[@]}" > raw_"$((++r))" &
done < <(cat ./tmp_*)
wait
