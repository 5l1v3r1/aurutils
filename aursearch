#!/bin/bash -e
export PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'

readonly cache="${XDG_CACHE_HOME:-$HOME/.cache}/aursearch"
readonly remote="https://aur.archlinux.org"
readonly rpc="$remote/rpc/?v=5&type=info"

filter() {
    tee # TBD
}

split() {
    awk -v rpc=$rpc '{
        # URL encode @ and +
        gsub("+","%2b"); gsub("@","%40");

        if ((NR % 150) == 0 || NR == 1)
            printf "\n%s&arg[]=%s", rpc, $0;
        else
            printf "&arg[]=%s", $0;
    }'
}

getjson() {
    aria2c -s 16 -x 16 -j 32 --log="$cache"/aria2c.log --log-level=info -q -i -
}

source /usr/share/makepkg/util.sh || exit 1

if ((!$#)); then
    error "aursearch: pattern"
    exit 1
fi

[[ -t 2 ]] && colorize

msg "Retrieving package list"
curl -sS "$remote"/packages.gz -o "$cache"/packages.gz -z "$cache"/packages.gz --create-dirs
zcat "$cache"/packages.gz | awk '!/^#/' > "$cache"/packages

msg "Sending request"
grep -P -- "$1" "$cache"/packages | split | getjson
