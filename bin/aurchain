#!/bin/bash
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o noclobber

argv0=aurchain
multinfo='https://aur.archlinux.org/rpc.php/rpc/?v=5&type=info'
tmp=$(mktemp -dt "$argv0".XXXXXXXXXX) || exit

readonly PS4 argv0 multinfo tmp
declare -i all=0

curl_safe() {
    curl --retry 3 -fgLsS --compressed "$1" || exit
}

url() {
    awk -v info="$multinfo" '{
        gsub("+","%2b")
        gsub("@","%40")

        if (NR == 1)
            printf "%s&arg[]=%s", info, $1
        else
            printf "&arg[]=%s", $1
    }'
}

count() {
    jshon -QF "$1" -e resultcount
}

pair() {
    for ((i = 0; i < "$1"; ++i)); do
        awk -v FS='[<=>]' 'NR == 1 {p = $1} NR > 1 {
        if ($0 != "null")
            printf("%s\t%s\n", p, $1);
        else
            printf("%s\t%s\n", p, p);
        }' <(jshon -CQF "$2" -e results -e "$i" -e Name -u -p -e Depends -a -u) \
           <(jshon -CQF "$2" -e results -e "$i" -e Name -u -p -e MakeDepends -a -u) \
           <(jshon -CQF "$2" -e results -e "$i" -e Name -u -p -e CheckDepends -a -u)
    done
}

f1() {
    awk '{print $1}' "$@" | sort -u
}

f2() {
    awk '{print $2}' "$@" | sort -u
}

dmsort() {
    if hash datamash 2>/dev/null; then
        datamash -W check < "$1" >/dev/null || return
    fi

    tsort "$1"
}

chain() {
    curl_safe "$(printf '%s\n' "$@" | url)" > json/0

    if [[ $(count json/0) -lt 1 ]]; then
        error "$argv0: no packages found"
        exit 1
    fi

    for ((a = 1; a <= 30; ++a)); do
        declare -i sub=$((a-1))

        pair "$(count json/$sub)" json/$sub > tsv/$sub

        f1 tsv/$sub >> pkgname
        f1 tsv/$sub >> seen

        sort -u tsv/$sub >> tsv/n

        # Avoid querying duplicates (#4)
        target=$(grep -Fxvf seen <(f2 tsv/$sub) | url)

        if [[ $target ]]; then            
            curl_safe "$target" > json/$a
        else
            break
        fi

        if [[ $(count json/$a) -lt 1 ]]; then
            break
        else
            f2 tsv/$sub >> seen
        fi
    done

    if ((a > 30)); then
        error "$argv0: total requests: $((++a)) (out of range)"
        exit 34
    fi

    if ! dmsort tsv/n; then
        error "$argv0: invalid argument"
        exit 22
    fi
}

trap_exit() {
    if [[ ! -o xtrace ]]; then
        rm -rf "$tmp"
    fi
}

trap 'trap_exit' EXIT

source /usr/share/makepkg/util.sh || exit

[[ -t 2 ]] && colorize

while getopts :a OPT; do
    case $OPT in
        a) all=1 ;;
        *) error "usage: $argv0 [-a] pkgname..."
           exit 2
    esac
done
shift $((OPTIND - 1))
OPTIND=1

if ((!$#)); then
    error "usage: $argv0 pkgname [pkgname...]"
    exit 1
fi

cd_safe "$tmp"
mkdir {json,tsv} || exit

# Generate dependency tree and pkgname list (pkgname).
chain "$@" > tree

if ((all)); then
    tac tree
else
    grep -Fxf pkgname tree | tac
fi

# vim: set et sw=4 sts=4 ft=sh:
