#!/bin/bash
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'

argv0=aurchain
tmp=$(mktemp -d) || exit

readonly argv0 tmp

curl_safe() {
    curl --retry 3 -sSgL "$@" || exit
}

count() {
    # $1 - request data
    jshon -F "$1" -Qe resultcount
}

deps() {
    # $1 - request data
    awk -v FS='[<=>]' '{print $1}' \
    <(jshon -F "$1" -Qe results -a -e Depends -a -u) \
    <(jshon -F "$1" -Qe results -a -e MakeDepends -a -u) \
    <(jshon -F "$1" -Qe results -a -e CheckDepends -a -u)
}

pair() {
    # $1 - resultcount
    # $2 - request data
    for ((i = 0; i < "$1"; ++i)); do
        awk -v FS='[<=>]' 'NR == 1 { p = $1 } NR > 1 { print p, $1 }' \
        <(jshon -F "$2" -Qe results -e "$i" -e Name -u -p -e Depends -a -u) \
        <(jshon -F "$2" -Qe results -e "$i" -e Name -u -p -e MakeDepends -a -u) \
        <(jshon -F "$2" -Qe results -e "$i" -e Name -u -p -e CheckDepends -a -u)
    done
}

request() {
    # Create pairs of package names and their dependencies.
    pair "$(count "$1")" "$1" > pair_all

    # Validate tsort data (#87)
    if datamash -W check < pair_all >/dev/null; then
        tsort pair_all | tac > list_tsort
    else
        error "$argv0: invalid argument"
        exit 22
    fi

    # Create a list of AUR results
    jshon -F "$1" -e results -a -e Name -u > list_name

    # Relative complement: pkgname (all, tsort) \ pkgname (AUR)
    grep -Fxf list_name list_tsort | awk -v arch="$(uname -m)" '{
        if(arch == "i686") gsub(/^lib32-/,"")
        print
    }'
}

url() {
    declare str='https://aur.archlinux.org/rpc.php/rpc/?v=5&type=info'

    while read -r p; do
        str+="&arg[]=$p"
    done

    printf '%s' "$str"
}

# Create a copy of the original arguments, and build a matching URL for
# AurJson. If there is at least one result, parse the request data for
# dependencies, append them to the original copy, and build a new
# URL. This continues until a certain maximum is exceeded, or no AUR
# results are found.
chain() {
    curl_safe "$(printf '%s\n' "$@" | tee copy | url)" > raw_0

    if [[ $(count raw_0) == 0 ]]; then
        error "$argv0: No packages found"
        exit 2
    fi

    for ((a = 1; a <= 100; ++a)); do
        curl_safe "$(deps raw_"$((--a))" | tee -a copy | url)" > raw_$a

        if [[ $(count raw_$a) == 0 ]]; then
            break
        fi
    done

    if ((a > 100)); then
        error "$argv0: total requests: $((++a)) (out of range)"
        exit 34
    fi
}

trap 'rm -rf "$tmp"' EXIT

source /usr/share/makepkg/util.sh || exit

[[ -t 2 ]] && colorize

if ((!$#)); then
    error "usage: $argv0 package [package, ...]"
    exit 1
fi

while getopts :v OPT; do
    case $OPT in
        v|+v) verbose=1 ;;
        *)  plain "usage: $argv0 [+-v} [--] ARGS..."
            exit 2
    esac
done
shift $((OPTIND - 1))
OPTIND=1

cd "$tmp" || exit

msg "Resolving dependencies..."
chain "$@"

# Write to FD 3 to not influence error reporting.
if ((verbose)); then
    if ( command >&3 ) 2>/dev/null; then
        sort -u copy >&3
        exec 3<&-
    else
        error "$argv0: bad file descriptor (fd 3)"
        exit 9
    fi
fi

if curl_safe "$(sort -u copy | url)" > raw_n; then
    request raw_n
fi
