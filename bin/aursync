#!/bin/bash
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -e -o pipefail -o noclobber

argv0=aursync
aurweb=https://aur.archlinux.org
tmp=$(mktemp -dt "$argv0".XXXXXXXXXX)
XDG_CACHE_HOME=${XDG_CACHE_HOME:-$HOME/.cache}
AURDEST=${AURDEST:-$XDG_CACHE_HOME/$argv0}

readonly argv0 aurweb tmp XDG_CACHE_HOME AURDEST

# Default options
declare -i chroot=0 insecure=0 nobuild=0 noversion=0 update=0
declare -i bindro=0 force=0 logdest=0 namcap=0 chtemp=0
declare deps=aurchain download=clone

viewer() {
    if hash 2>/dev/null vifm; then
        vifm - '+view!'
    else
        command -- "${PAGER:-less}"
    fi
}

inspect() {
    xargs -i find {} -maxdepth 1 | viewer
}

revcheck() {
    #global tmp
    git fetch -v

    # git fetch will return 0 even if nothing was fetched.
    if [[ $(git rev-parse HEAD) != $(git rev-parse '@{upstream}') ]]; then
        git --no-pager log --patch --stat '..@{upstream}' >> "$tmp/$1".diff
        git reset --hard HEAD
        git merge
    fi
}

clone() {
    #global aurweb
    declare b

    while read -r b _; do
        if [[ -d $b/.git ]]; then
            GIT_DIR="$b"/.git GIT_WORK_TREE="$b" revcheck "$b"
        else
            git clone "$aurweb/$b".git
        fi
    done
}

aria() {
    #global aurweb tmp
    awk -v uri="$aurweb"/cgit/aur.git/snapshot '{
        gsub("+","%2b")
        gsub("@","%40")

        printf "%s/%s.tar.gz\n", uri, $1
    }' | aria2c -d "$tmp" -i -

    for ar in "$tmp"/*.tar.gz; do
        tar xvf "$ar"
    done
}

print() {
    printf '%s\n' "$@"
}

trap 'rm -rf "$tmp"' EXIT

source /usr/share/makepkg/util.sh

[[ -t 2 ]] && colorize

while getopts :B:cdfhkLntTuvw OPT; do
    case $OPT in
        B|+B) bindro=1
              newdir=$OPTARG ;;
        c|+c) chroot=1       ;;
        d|+d) deps=print     ;;
        f|+f) force=1        ;;
        k|+k) insecure=1     ;;
        L|+L) logdest=1      ;;
        n|+n) namcap=1       ;;
        t|+t) download=aria  ;;
        T|+T) chtemp=1       ;;
        u|+u) update=1       ;;
        v|+v) noversion=1    ;;
        w|+w) nobuild=1      ;;
        *) plain "usage: $argv0 [-c] [-B newdir] [-dfhkLtTuvw] [--] pkgname..."
           exit 1 ;;
    esac
done
shift $((OPTIND - 1))
OPTIND=1

# Set makepkg args in a new list to ensure option context is already
# defined, as getopts parses options sequentially.
if ((chroot)); then
    ((bindro))  && makepkg_args+=(-D "$newdir")
    ((chtemp))  && makepkg_args+=(-T)
    ((namcap))  && makepkg_args+=(-n)
else
    ((force))   && makepkg_args+=(-f)
    ((logdest)) && makepkg_args+=(-L)
    ((namcap))  && makepkg_args+=(--noconfirm)
fi

# Select file:// repository.
read -r repo pool < <(repofind -s)

# Reuse selection for repofind (#82)
if ((update)); then
    update_targets=($(repofind -u "$repo" | awk '{print $1}'))

    if [[ ! ${update_targets[@]} ]]; then
        msg2 "No updates available"
    else
        set -- "$@" "${update_targets[@]}"
    fi
fi

if ((!$#)); then
    error "$argv0: no targets specified"
    exit 1
fi

# Use a separate tar directory to prevent conflicts with git.
mkdir -p "$AURDEST"/snapshot
chmod -c 700 "$AURDEST"

if [[ $download == aria ]]; then
    cd "$AURDEST"/snapshot
else
    cd "$AURDEST"
fi

# Save temporary files in directories by context
mkdir "$tmp"/{list,pair,tsort}

# Copy the queue and dependency tree for later processing, and
# retrieve AUR metadata.
"${deps:-aurchain}" "$@" | tee "$tmp"/tsort/name | xargs -r aursearch -Fr > "$tmp"/raw

# Create pairs of pkgname and pkgbase, and pkgname and pkgver.
jshon -F "$tmp"/raw -a -e results -a -e Name -u -p -e PackageBase -u | xargs -n2 > "$tmp"/pair/base
jshon -F "$tmp"/raw -a -e results -a -e Name -u -p -e Version -u | xargs -n2 > "$tmp"/pair/ver

# Replace package name with package base, preserving order, copy
# results, and download build files.
aursplit "$tmp"/pair/base < "$tmp"/tsort/name | tee "$tmp"/tsort/base | "${download:-clone}"

if ! ((noversion)); then
    # Print updated pkgbase from versioned pairs.
    aursift -U < "$tmp"/pair/ver | aursplit "$tmp"/pair/base > "$tmp"/list/base

    # Relative complement: pkgbase (tsort) \ pkgbase (updated)
    grep -Fxvf "$tmp"/list/base "$tmp"/tsort/base > "$tmp"/queue
else
    cp "$tmp"/tsort/base "$tmp"/queue
fi

# View changes and build files in one window (#77)
if ! ((insecure)); then
    ( shopt -s nullglob
      printf '%s\n' "$tmp"/*.diff | cat - "$tmp"/queue | inspect
    )
fi

if ((nobuild)); then
    msg "Files downloaded to $PWD"
    exit
fi

if ((chroot)); then
    aurbuild_args+=(-c)
fi

aurbuild_args+=(-d "$repo" -r "$pool" -p "$pool" -a "$tmp"/queue)
aurbuild "${aurbuild_args[@]}" -- "${makepkg_args[@]}"
