#!/bin/bash
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o pipefail

argv0=repofind
readonly PS4 argv0

repofind() {
    declare repo
    declare -A rset

    for repo in $(pacconf --repo-list); do
        rset[$repo]=$(pacconf --single --repo="$repo" Server)

        if [[ ${rset[$repo]} =~ file:// ]]; then
            printf '%s %s\n' "$repo" "${rset[$repo]}"
        fi
    done
}

repocheck() {
    declare -A rset
    rset[$1]=$(pacconf --single --repo="$1" Server) || exit

    if [[ ${rset[$1]} =~ file:// ]]; then
        printf '%s %s\n' "$1" "${rset[$1]}"
    else
        error "$argv0: $1: not a file:// repository"
        exit 1
    fi
}

reposelect() {
    declare repo server root
    declare -A avail

    while read -r repo server; do
        avail[$repo]=$server
    done < <(repofind)

    if ((${#avail[@]} > 1)); then
        PS3='Select a repository: '
        select repo in "${!avail[@]}"; do
            break
        done
    elif [[ ${avail[@]} ]]; then
        repo=${!avail[*]}
    else
        error "$argv0: no file:// repository"
        exit 2
    fi

    root=${avail[$repo]#file://}

    printf '%s %s\n' "$repo" "$root"
}

source /usr/share/makepkg/util.sh || exit

[[ -t 2 ]] && colorize

while getopts :ik:s OPT; do
    case $OPT in
        i|+i) repofind   ;;
        s|+s) reposelect ;;
        k|+k) repocheck "$OPTARG" ;;
        *) plain "usage: $argv0 [-i] [-s] [-k repo]"
           exit 1 ;;
    esac
done
shift $((OPTIND - 1))
OPTIND=1

# vim: set et sw=4 sts=4 ft=sh:
