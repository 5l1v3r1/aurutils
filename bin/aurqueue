#!/bin/bash
# shellcheck disable=SC2016
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o pipefail

argv0=aurqueue
tmp=$(mktemp -dt "$argv0".XXXXXXXXXX) || exit

readonly PS4 argv0 tmp

# Determine the path to each .SRCINFO, output to stdout using null
# delimitation to prevent ARG_MAX issues.
findsrc() {
    find -- "$@" -maxdepth 1 -type f -name .SRCINFO -print0
}

# Use xargs to pass a list of paths to .SRCINFOs for processing, skip
# to the next file when a split package is found, and output
# dependencies on stdout.
gendeps() {
    xargs -0i awk -v FS='[<=>]' '
          /pkgbase/                 {B = $2; printf("%s\t%s\n", B, B)}
          /^\t(make|check)?depends/ {printf("%s\t%s\n", B, $2)}
          /^$/                      {nextfile}
    ' {}
}

allnames() {
    xargs -0i awk -v FS='[<=>]' '
          /pkgbase/ {B = $2}
          /pkgname/ {printf("%s\t%s\n", $2, B)}
    ' {}
}

dmsort() {
    if hash datamash 2>/dev/null; then
        datamash -W check < "$1" >/dev/null || return
    fi

    tsort "$1"
}

trap_exit() {
    if [[ ! -o xtrace ]]; then
        rm -rf "$tmp"
    fi
}

trap 'trap_exit' EXIT

source /usr/share/makepkg/util.sh || exit

if ((!$#)); then
    error "usage: $argv0 pkgbase [pkgbase...]"
    exit 1
fi

[[ -t 2 ]] && colorize

if findsrc "$@" > "$tmp"/info; then
    gendeps  < "$tmp"/info > "$tmp"/deps &
    allnames < "$tmp"/info > "$tmp"/base &
    wait

    # pkgbase can be specified explicitely, and does not have to match
    # values in the pkgname array. As source directories are however
    # named after pkgbase, differences must be replaced in the initial
    # graph before matching the original arguments.    
    dmsort "$tmp"/deps | aursplit "$tmp"/base | tac > "$tmp"/queue

    # The base assumption is to have packages and their dependencies
    # already available, so instead of filtering packages in the official
    # repositories, we simply remove those that weren't there in the first
    # place. As an added benefit, any directory with SRCINFO files can now
    # be included in the queue.
    grep -Fxf <(printf '%s\n' "$@") "$tmp"/queue
fi

# vim: set et sw=4 sts=4 ft=sh:
