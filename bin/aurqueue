#!/bin/bash
# shellcheck disable=SC2016
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o pipefail

argv0=aurqueue
tmp=$(mktemp -dt "$argv0".XXXXXXXXXX) || exit

readonly PS4 argv0 tmp

dmsort() {
    if hash datamash 2>/dev/null; then
        datamash -W check < "$1" >/dev/null || return
    fi

    tsort "$1"
}

trap_exit() {
    if [[ ! -o xtrace ]]; then
        rm -rf "$tmp"
    fi
}

trap 'trap_exit' EXIT

source /usr/share/makepkg/util.sh || exit

if ((!$#)); then
    error "usage: $argv0 pkgbase [pkgbase...]"
    exit 1
fi

[[ -t 2 ]] && colorize

find -- "$@" -maxdepth 1 -type f -name .SRCINFO -print0 | xargs -0 gawk '
    BEGINFILE {
        print "STOP"
    } {
        print
    }
' > "$tmp"/i

gawk -v FS='[<=>]' '
    /STOP/ {
        read = 1
    } {
        if (read && $0 ~ /pkgbase/) {
            pb = $2
            printf("%s\t%s\n", pb, pb)
        }
        if (read && $0 ~ /^\t(make|check)?depends/) {
            printf("%s\t%s\n", pb, $2)
        }
        if ($0 ~ /^$/) {
            read = 0    # split package
        }
    }
' "$tmp"/i > "$tmp"/deps

gawk -v FS='[<=>]' '
    /pkgbase/ {
        pb = $2
    }
    /pkgname/ {
        printf("%s\t%s\n", $2, pb)
    }
' "$tmp"/i > "$tmp"/base

dmsort "$tmp"/deps | gawk '
    NR == FNR {
        x[$1] = $2; next
    } {
        if ($1 in x && !(x[$1] in seen)) {
            print x[$1]; seen[x[$1]];
        }
    }
' "$tmp"/base - | grep -Fxf <(printf '%s\n' "$@") | tac

# vim: set et sw=4 sts=4 ft=sh:
