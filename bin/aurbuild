#!/bin/bash
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -e

argv0=aurbuild
base=$PWD
tmp=$(mktemp -dt "$argv0".XXXXXXXXXX)

readonly PS4 argv0 base tmp
declare -i chroot=0 sign_pkg=0

# Use an option array to allow later modification by getopts.
makepkg_args=(-Lcrs)
makechrootpkg_args=(-cu)
repose_args=(-vf)

# The repo equivalent of "makepkg -i". An interesting side effect is
# that pacman now considers packages inside the official repositories
# as "local", and warns if they are newer than a custom counterpart.
build_local() {
    #global database pool root makepkg_args repose_args sign_pkg
    if ((sign_pkg)); then
        makepkg_args+=(--sign)
    fi

    PKGDEST="$pool" LC_MESSAGES=C makepkg "${makepkg_args[@]}"

    # Set LANG=C to allow libalpm to fully read the database, even
    # when the locale is not set.
    # https://bugs.archlinux.org/task/49342#comment147145
    LANG=C repose "${repose_args[@]}" "$database" -r "$root" -p "$pool"

    printf '%s\n%s\n' "[$database]" "$(pacconf --repo="$database")" > "$tmp"/config
    sudo pacman -Syu --config="$tmp"/config --noprogressbar
}

# With an nspawn container, packages are always built against the latest
# official packages, and are upgraded together on a local -Syu. 
# '/pkgdest' is hardcoded in makechrootpkg, so packages are rebuilt even if
# already available. Build products are moved to a fixed location afterwards.
build_chroot() {
    #global CHROOT GPGKEY database pool root makechrootpkg_args repose_args sign_pkg
    declare i gpgargs pkglist PKGDEST
    readarray -t pkglist < <(makepkg --packagelist)

    # makechrootpkg does not support GNUPGHOME. (#151)
    if [[ ${GNUPGHOME:-$HOME/.gnupg} != $HOME/.gnupg ]]; then
        warning "GNUPGHOME is not set to $HOME/.gnupg"
    fi

    # XXX Move build products manually: PKGDEST is not preserved (#120) in makechrootpkg,
    # while variables on the sudo command line and sudo -E are subject to sudoers policy. 
    # Specifiying PKGDEST like this doesn't work anyway; variables in /etc/makepkg.conf
    # and (after that) ~$SUDO_USER/.makepkg.conf take precedence over an existing PKGDEST.
    # Unlike makepkg, a different config file can also not be set from the command line.
    PKGDEST=$(pacini /etc/pacman.conf PKGDEST)

    if [[ ! $PKGDEST && -r ~/.makepkg.conf ]]; then
        PKGDEST=$(pacini ~/.makepkg.conf PKGDEST)
    fi

    if [[ $PKGDEST ]]; then
        dequote PKGDEST
    fi

    makechrootpkg "${makechrootpkg_args[@]}" -d "$pool" -d "$root" -r "$CHROOT"

    if [[ ${PKGDEST:-$PWD} != "$pool" ]]; then
        for i in "${pkglist[@]}"; do
            find "${PKGDEST:-$PWD}" -type f -regex ".+/$i.pkg.+?" -execdir mv -v {} -t "$pool" \;
        done
    fi

    # Using pinentry inside the chroot fails due to DISPLAY and GPG_TTY
    # not being set. (#130)
    if ((sign_pkg)); then
        gpgargs=(--verbose --detach-sign --no-armor)

        if [[ $GPGKEY ]]; then
            gpgargs+=(-u "$GPGKEY")
        fi

        for i in "${pkglist[@]}"; do
            find "$pool" -type f -regex ".+/$i.pkg.+?" -execdir gpg "${gpgargs[@]}" {} \;
        done
    fi

    LANG=C repose "${repose_args[@]}" "$database" -r "$root" -p "$pool"
}

dequote() {
    declare -n sub=$1
    sub=${sub#\"}; sub=${sub%\"}
    sub=${sub#\'}; sub=${sub%\'}
}

trap_exit() {
    if [[ ! -o xtrace ]]; then
        rm -rf "$tmp"
    fi
}

trap 'exit' INT
trap 'trap_exit' EXIT

source /usr/share/makepkg/util.sh

[[ -t 2 ]] && colorize

while getopts a:cd:p:r:s OPT; do
    case $OPT in
        a|+a) queue="$OPTARG" ;;
        c|+c) chroot=1 ;;
        d|+d) database="$OPTARG" ;;
        p|+p) pool="$OPTARG" ;;
        r|+r) root="$OPTARG" ;;
        s|+s) repose_args+=(--sign)
              sign_pkg=1 ;;
        *) plain "usage: $argv0 [-cs] -a <queue> -d <repo> -p <pool> -r <root> [--] ARGS"
           exit 1 ;;
    esac
done
shift $((OPTIND - 1))
OPTIND=1

if [[ ! $queue || ! $database || ! $pool || ! $root ]]; then
    error "$argv0: empty arguments"
    exit 1
elif [[ ! -r $queue ]]; then
    error "$argv0: \'$queue\': permission denied"
    exit 13
elif [[ -d $queue ]]; then
    error "$argv0: \'$queue\': is a directory"
    exit 21
elif ! pacconf --repo="$database" >/dev/null; then
    exit 22
fi

# Canonicalize paths to avoid issues with chdir and relative paths.
pool=$(realpath -e "$pool")
root=$(realpath -e "$root")

if [[ ! -w $root ]]; then
    error "$argv0: $root: permission denied"
    exit 13
elif [[ ! -w $pool ]]; then
    error "$argv0: $pool: permission denied"
    exit 13
elif [[ ! -d $root ]]; then
    error "$argv0: $root: not a directory"
    exit 20
elif [[ ! -d $pool ]]; then
    error "$argv0: $pool: not a directory"
    exit 20
fi

# Reset option array if arguments are specified after --
if (($#)); then
    if ((chroot)); then
        makechrootpkg_args+=("$@")
    else
        makepkg_args+=("$@")
    fi
fi

if ((chroot)); then
    CHROOT=/var/lib/aurbuild

    if [[ ! -d $CHROOT/root ]]; then
        sudo install -d "$CHROOT"
        sudo mkarchroot "$CHROOT"/root base base-devel
    else
        # since makechrootpkg restores the user chroot to the state from root chroot
        # base and base-devel packages are reupdated before each package build
        # this updates the root once before starting package build process to prevent that
        sudo arch-nspawn "$CHROOT"/root pacman -Syu --noconfirm
    fi

    # Retrieve settings from pacman.conf and Include directives.
    pacconf --raw | sudo tee "$CHROOT"/root/etc/pacman.conf > /dev/null
fi

# Read from FD 3 to choose providers with makepkg (#21)
exec 3< "$queue"

while read -r -u 3 pkg _; do
    if cd "$base/$pkg"; then
        if ((chroot)); then
            build_chroot
        else
            build_local
        fi
    fi
done

exec 3<&-

# vim: set et sw=4 sts=4 ft=sh:
