#!/bin/bash
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o pipefail

argv0=aurcheck
tmp=$(mktemp -dt "$argv0".XXXXXXXXXX) || exit
declare all=0 quiet=0 database=
declare -r PS4 argv0 tmp

aurver() {
    xargs -r aursearch -Fr | jq -r '.[].results[] |
        [.Name,.Version,.Maintainer] | @tsv'
}

quickcheck() {
    declare geq=$1 cmp=$2
    declare pkg v_pkg v_aur op

    sort -k 1b,1 > pkg.tsv

    if awk '{print $1}' pkg.tsv | aurver | sort -k 1b,1 > aur.tsv; then
        join -v 2 -o 2.1 aur.tsv pkg.tsv | while IFS= read -r; do
            plain "$REPLY is not present in AUR"
        done

        awk '{if(!$3) {print $1};}' aur.tsv | while IFS= read -r; do
            plain "$REPLY is orphaned in AUR"
        done
    else
        exit
    fi

    while read -r pkg v_pkg v_aur _; do
        if [[ $v_pkg != "$v_aur" ]]; then
            op=$(vercmp "$v_pkg" "$v_aur")
        else
            op=0
        fi

        if ((!geq && op > -1)); then
            continue
        fi

        if ((!cmp)); then
            case "$op" in
                -1) printf '%s %s -> %s\n' "$pkg" "$v_pkg" "$v_aur" ;;
                 0) printf '%s %s = %s\n'  "$pkg" "$v_pkg" "$v_aur" ;;
                 1) printf '%s %s <- %s\n' "$pkg" "$v_pkg" "$v_aur" ;;
            esac
        else
            printf '%s\n' "$pkg"
        fi
    done < <(join pkg.tsv aur.tsv)
}

syncver() {
    if [[ $1 ]]; then
	pacsift --repo="$1" <&- | pacman -Sddp --print-format '%n %v' -
    else
        tee
    fi
}

usage() {
    plain "usage: $argv0 [-aq] -d repository"
    exit 1
}

trap_exit() {
    if [[ ! -o xtrace ]]; then
        rm -rf "$tmp"
    fi
}

trap 'trap_exit' EXIT

source /usr/share/makepkg/util.sh || exit

[[ -t 2 ]] && colorize

while getopts :ad:q OPT; do
    case $OPT in
        a) all=1 ;;
        d) database=$OPTARG ;;
        q) quiet=1 ;;
        *) usage ;;
    esac
done
shift $((OPTIND - 1))
OPTIND=1

cd_safe "$tmp"

syncver "$database" | quickcheck "${all:-0}" "${quiet:-0}"

# vim: set et sw=4 sts=4 ft=sh:
