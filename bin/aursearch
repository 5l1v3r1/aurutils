#!/bin/bash
PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o pipefail

argv0=aursearch
aurweb="https://aur.archlinux.org"
tmp=$(mktemp -dt "$argv0".XXXXXXXXXX) || exit

readonly PS4 argv0 aurweb tmp
format=short
list=pkgname
searchby=name

command_exists () {
    type "$1" &> /dev/null
}

urlencode() {
    jq -R -r '@uri'
}

# Split by 150 arguments to prevent HTTP 414.
# https://bugs.archlinux.org/task/49089
split() {
    awk -v rpc="$aurweb/rpc/?v=5&type=info" '{
        if (NR == 1)
            printf "%s&arg[]=%s", rpc, $0
        if (NR > 1)
            printf "&arg[]=%s", $0
        if (NR % 150 == 0)
            printf "\n%s&arg[]=%s", rpc, $0
    } END {
        printf "\n"
    }'
}

getjson() {
    if command_exists aria2c; then
        aria2c --download-result=hide --console-log-level=error --stderr=true -d "$tmp" -i - && cat $tmp/index*.html* > $tmp/out.json
    elif command_exists parallel; then
        parallel --will-cite -X "curl -s -g {}" > $tmp/out.json
    else
        readarray -t uri
        curl -s  -g "${uri[@]}" > $tmp/out.json
    fi

    if [ $? -eq 0 ]; then
        sed -e '1i[' -e 's/}{/},{/g' -e '$a]' -i $tmp/out.json

        declare -i totalresults
        totalresults=$(cat $tmp/out.json | jq '[.[].resultcount] | reduce .[] as $c (0; . + $c)')

        if [[ $totalresults -gt 0 ]]; then
            cat $tmp/out.json
        else
            error "$argv0: no results found"
            exit 1
        fi
    else
        exit $?
    fi
}

json_short() {
    while {
        read -r Name
        read -r Version
        read -r NumVotes
        read -r Description
    }; do
        printf "${BLUE}aur/${ALL_OFF}${BOLD}%s ${GREEN}%s ${ALL_OFF}(%s)\n    %s\n" \
               "$Name" "$Version" "$NumVotes" "$Description"
    done < <(jq -r '[.[].results[]] | sort_by(.Name)[] | .Name,
      .Version,
      .NumVotes,
      .Description')
}

json_long() {
    while {
        read -r Name
        read -r PackageBase
        read -r Version
        read -r Description
        read -r URL
        read -r NumVotes
        read -r Popularity
        read -r OutOfDate
        read -r Maintainer
        read -r FirstSubmitted
        read -r LastModified
    }; do
        printf "Name:            %s\n" "$Name"
        printf "Base:            %s\n" "$PackageBase"
        printf "Version:         %s\n" "$Version"
        printf "Description:     %s\n" "$Description"
        printf "URL:             %s\n" "$URL"
        printf "Votes:           %s\n" "$NumVotes"
        printf "Popularity:      %s\n" "$Popularity"
        printf "Out Of Date:     %s\n" "$OutOfDate"
        printf "Maintainer:      %s\n" "$Maintainer"
        printf "First Submitted: %s\n" "$(date -d @"$FirstSubmitted" '+%c')"
        printf "Last Modified:   %s\n" "$(date -d @"$LastModified" '+%c')"
        printf '%s\n'
    done < <(jq -r '[.[].results[]] | sort_by(.Name)[] | .Name,
        .PackageBase,
        .Version,
        .Description,
        .URL,
        .NumVotes,
        .Popularity,
        .OutOfDate,
        .Maintainer,
        .FirstSubmitted,
        .LastModified')
}

match() {
    declare e ptr args

    for e in "${@:2}"; do
        ptr+=(-e "$e")
    done

    case "$1" in
        pkgbase)
            args+=(-b)
            ;;&
        pkgname|pkgbase)
            aurgrep "${args[@]}" -- "${ptr[@]}"
            ;;
        fixed)
            printf '%s\n' "${@:2}"
            ;;
    esac
}

parse() {
    case "$1" in
        short) json_short ;;
        long)  json_long  ;;
        none)  tee ;;
    esac
}

trap_exit() {
    if [[ ! -o xtrace ]]; then
        rm -rf "$tmp"
    fi
}

trap 'trap_exit' EXIT
source /usr/share/makepkg/util.sh || exit

if [[ -t 2 ]]; then
    colorize
fi

while getopts :PFbrvmd OPT; do
    case $OPT in
        P|F) searchby='' ;;&
        F) list=fixed   ;;
        b) list=pkgbase ;;
        r) format=none  ;;
        v) format=long  ;;
        m) searchby=maintainer ;;
        d) searchby=name-desc ;;
    esac
done
shift $((OPTIND - 1))
OPTIND=1

if ((!$#)); then
    plain "$argv0: no targets specified"
    exit 1
fi

if [ -n "$searchby" ]; then
  { for q in "$@"; do
    echo -n "$aurweb/rpc/?v=5&type=search&by=$searchby&arg="
    echo "$q" | urlencode
  done } | getjson | parse "$format"
else
  match "$list" "$@" | urlencode | split | getjson | parse "$format"
fi

# vim: set et sw=4 sts=4 ft=sh:
